-----------------------------------------------------------------------------------------------------------------------------------------
-- VRP
-----------------------------------------------------------------------------------------------------------------------------------------
local Tunnel = module("vrp","lib/Tunnel")
local Proxy = module("vrp","lib/Proxy")
vRP = Proxy.getInterface("vRP")
-----------------------------------------------------------------------------------------------------------------------------------------
-- CONNECTION
-----------------------------------------------------------------------------------------------------------------------------------------
cVRP = {}
Tunnel.bindInterface("rotas",cVRP)
vSERVER = Tunnel.getInterface("rotas")
-----------------------------------------------------------------------------------------------------------------------------------------
-- VARIABLES
-----------------------------------------------------------------------------------------------------------------------------------------
local blip = false
local Service = false
local Selected = 0
local Start = 0
local cdsStart = {
    { 2990.2,3040.56,108.86,"Arcade" },
    { 130.14,-1325.05,29.21,"Vanilla" },
}
-----------------------------------------------------------------------------------------------------------------------------------------
-- LOCATIONS
-----------------------------------------------------------------------------------------------------------------------------------------
local locs = {
    -- Vanilla --
   	[1] = 	{ 117.83,-1305.11,29.23 },
    [2] = 	{ 952.8,-252.47,67.96 },
	[3] = 	{ 930.62,-245.06,69.0 },
	[4] = 	{ 920.99,-238.29,70.36 },
	[5] = 	{ 895.76,-202.14,71.97 },
	[6] = 	{ 840.55,-182.1,74.39 },
	[7] = 	{ 808.77,-163.79,75.87 },
	[8] = 	{ 798.53,-158.84,74.9 },
	[9] = 	{ 773.71,-150.13,75.62 },
	[10] = 	{ 1060.5,-378.17,68.22 },
	[11] = 	{ 1028.8,-408.26,66.34 },
	[12] = 	{ 1010.38,-423.4,65.34 },
	[13] = 	{ 987.58,-433.01,64.05 },
	[14] = 	{ 967.27,-451.79,62.78 },
	[15] = 	{ 944.46,-463.22,61.55 },
	[16] = 	{ 921.88,-477.9,61.08 },
	[17] = 	{ 906.45,-489.69,59.43 },
	[18] = 	{ 878.6,-498.13,58.08 },
	[19] = 	{ 861.51,-509.03,57.71 },
	[20] = 	{ 850.48,-532.66,57.93 },
	[21] = 	{ 844.13,-562.74,58.0 },
	[22] = 	{ 861.63,-583.55,58.15 },
	[23] = 	{ 886.78,-608.21,58.45 },
	[24] = 	{ 903.01,-615.54,58.45 },
	[25] = 	{ 928.88,-639.7,58.23 },
	[26] = 	{ 943.52,-653.47,58.42 },
	[27] = 	{ 960.31,-669.67,58.45 },
	[28] = 	{ 970.82,-701.28,58.49 },
	[29] = 	{ 979.18,-716.24,58.22 },
	[30] = 	{ 996.91,-729.44,57.81 },
	[31] = 	{ 980.19,-627.61,59.23 },
	[32] = 	{ 965.19,-541.92,59.72 },
	[33] = 	{ 1006.44,-511.06,61.0 },
	[34] = 	{ 1090.42,-484.36,65.66 },
    -- Arcade --
	[35] = 	{ 35.36,6662.98,32.18 },
	[36] = 	{ -9.61,6654.22,31.69 },
	[37] = 	{ -41.67,6637.43,31.09 },
	[38] = 	{ -130.72,6551.93,29.87 },
	[39] = 	{ -214.93,6444.22,31.31 },
	[40] = 	{ -245.93,6414.41,31.46 },
	[41] = 	{ -272.43,6400.8,31.49 },
	[42] = 	{ -363.99,6339.7,29.84 },
	[43] = 	{ -407.38,6314.18,28.93 },
	[44] = 	{ -437.88,6272.34,30.06 },
	[45] = 	{ -442.52,6197.86,29.55 },
	[46] = 	{ -374.54,6191.04,31.73 },
	[47] = 	{ -356.87,6207.43,31.85 },
	[48] = 	{ -347.47,6225.41,31.88 },
	[49] = 	{ -379.89,6252.89,31.85 },
	[50] = 	{ -371.06,6266.77,31.88 },
	[51] = 	{ -332.76,6302.38,33.09 },
	[52] = 	{ -302.24,6327.03,32.89 },
	[53] = 	{ -280.64,6350.75,32.6 },
	[54] = 	{ -247.83,6370.12,31.85 },
	[55] = 	{ -227.39,6377.58,31.76 },
	[56] = 	{ -213.78,6396.32,33.08 },
	[57] = 	{ -188.86,6409.55,32.3 },
	[58] = 	{ -105.53,6528.76,30.16 },
	[59] = 	{ -44.34,6582.06,32.17 },
	[60] = 	{ -26.74,6597.33,31.86 },
	[61] = 	{ 1.63,6612.62,32.08 },
	[62] = 	{ 31.19,6596.67,32.82 },
	[63] = 	{ 11.52,6578.27,33.06 },
	[64] = 	{ -15.24,6557.58,33.24 }
}
-----------------------------------------------------------------------------------------------------------------------------------------
-- THREADSERVICE
-----------------------------------------------------------------------------------------------------------------------------------------
Citizen.CreateThread(function()
	while true do
		local timeDistance = 500
		local ped = PlayerPedId()
		if not IsPedInAnyVehicle(ped) then
			local coords = GetEntityCoords(ped)
			for k,v in pairs(cdsStart) do
			    local distance = #(coords - vector3(v[1],v[2],v[3]))
                if distance <= 1 then
                    timeDistance = 4

                    if Service then
                        DrawText3D(v[1],v[2],v[3],"~g~E~w~   FINALIZAR")
                        if IsControlJustPressed(1,38) then
                            RemoveBlip(blip)
                            Service = false
							TriggerEvent("Notify","vermelho","Fim do ServiÃ§o.",5000)
                        end
                    else
                        DrawText3D(v[1],v[2],v[3],"~g~E~w~   INICIAR")
                        if IsControlJustPressed(1,38) and vSERVER.checkPermission() then
                            Service = true
                            if v[4] == "Vanilla" then
                                Start = 1
                                Selected = Start
                            elseif v[4] == "Arcade" then
                                Start = 35
                                Selected = Start
                            end
							makeBlipMarked()
							TriggerEvent("Notify","verde","Marcando Locais de entregas.",5000)
                        end
                    end 
                end
            end
		end
		Citizen.Wait(timeDistance)
	end
end)

-----------------------------------------------------------------------------------------------------------------------------------------
-- THREADCOLLECT
-----------------------------------------------------------------------------------------------------------------------------------------
Citizen.CreateThread(function()
	while true do
		local timeDistance = 1000
		if Service then
			local ped = PlayerPedId()
            if not IsPedInAnyVehicle(ped) then
                local coords = GetEntityCoords(ped)
                local distance = #(coords - vector3(locs[Selected][1],locs[Selected][2],locs[Selected][3]))
                if distance <= 30 then
                    timeDistance = 5
                    DrawText3D(locs[Selected][1],locs[Selected][2],locs[Selected][3],"~g~E~w~   COLETAR")
                    if distance <= 1 and IsControlJustPressed(1,38) and vSERVER.paymentMethod() then
                        RemoveBlip(blip)

                        Selected = math.random(#locs)
                        makeBlipMarked()
                    end
                end
            end
        end
        Citizen.Wait(timeDistance)
    end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- DRAWTEXT3D
-----------------------------------------------------------------------------------------------------------------------------------------
function DrawText3D(x,y,z,text,h,g,f)
	SetTextFont(4)
	SetTextCentre(1)
	SetTextEntry("STRING")
	SetTextScale(0.35,0.35)
	SetTextColour(255,255,255,150)
	AddTextComponentString(text)
	SetDrawOrigin(x,y,z,0)
	DrawText(0.0,0.0)
	local factor = (string.len(text) / 375) + 0.01
	DrawRect(0.0,0.0125,factor,0.03,38,42,56,200)
	ClearDrawOrigin()
end
-----------------------------------------------------------------------------------------------------------------------------------------
-- CRIANDOBLIP
-----------------------------------------------------------------------------------------------------------------------------------------
function makeBlipMarked()
	if DoesBlipExist(blip) then
		RemoveBlip(blip)
		blip = nil
	end
	blip = AddBlipForCoord(locs[Selected][1],locs[Selected][2],locs[Selected][3])
	SetBlipSprite(blip,12)
	SetBlipColour(blip,77)
	SetBlipScale(blip,0.7)
	SetBlipAsShortRange(blip,false)
	SetBlipRoute(blip,true)
	BeginTextCommandSetBlipName("STRING")
	AddTextComponentString("Coleta")
	EndTextCommandSetBlipName(blip)
end